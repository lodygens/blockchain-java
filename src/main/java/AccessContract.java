import java.io.IOException;
import java.math.BigInteger;
import java.util.logging.Level;
import java.util.logging.Logger;

import org.web3j.crypto.CipherException;
import org.web3j.crypto.Credentials;
import org.web3j.crypto.WalletUtils;
import org.web3j.protocol.Web3j;
import org.web3j.protocol.core.methods.response.TransactionReceipt;
import org.web3j.protocol.core.methods.response.Web3ClientVersion;
import org.web3j.protocol.http.HttpService;

import xwhep.blockchain.ProofOfExistence3;

/*
 * This Java source file was auto generated by running 'gradle buildInit --type java-library'
 * by 'mboleg' at '15/01/18 13:22' with Gradle 2.14.1
 *
 * @author mboleg, @date 15/01/18 13:22
 */
public class AccessContract {

	private Logger logger;
	private static final String walletPath = "/Users/mboleg/Library/Ethereum/testnet/keystore/UTC--2018-01-18T13-16-51.283000000Z--8e1b391cc1c7d225c8200d4d6ab467ef2548323c.json";
	private static final String walletPwd = "toto";
	private Web3j web3;
	private Credentials credentials;
	private ProofOfExistence3 proofOfExistence3;

	public AccessContract(){
		logger = Logger.getLogger(this.getClass().getName());
		web3 = Web3j.build(new HttpService());  // defaults to http://localhost:8545/
		credentials = null;
	}

	private void checkVersion() {
		Web3ClientVersion web3ClientVersion;
		try {
			web3ClientVersion = web3.web3ClientVersion().send();
			final String clientVersion = web3ClientVersion.getWeb3ClientVersion();
			logger.log(Level.INFO, "Client version " + clientVersion);
		} catch (IOException e) {
			logger.warning(e.getMessage());
			System.exit(1);
		}
	}

	private void getCredentials(final String path, final String passwd) {
		logger.info("Wallet : " + path);
		logger.info("Passwd : " + passwd);
		try {
			credentials = WalletUtils.loadCredentials(passwd, path);
			logger.log(Level.INFO, "Credentials " + credentials.getAddress());
		} catch (IOException | CipherException e) {
			logger.warning(e.getMessage());
			System.exit(1);
		}
	}

	void loadContract(final String addr) {
		proofOfExistence3 = ProofOfExistence3.load(addr, web3, credentials, BigInteger.valueOf(1000), BigInteger.valueOf(1000));
		logger.log(Level.INFO, "Contract address " + proofOfExistence3.getContractAddress());
	}

	private void checkDocument(final String doc)  {
		Boolean b;
		try {
			b = proofOfExistence3.checkDocument(doc).send();
			logger.info("checkDocument " + b.toString());
		} catch (Exception e) {
			logger.warning("checkDocument " + e.getMessage());
		}
	}

	private void notarize(final String doc) {
		TransactionReceipt receipt;
		try {
			receipt = proofOfExistence3.notarize(doc).send();
			logger.info("checkDocument " + receipt.toString());
		} catch (Exception e) {
			logger.warning("notarize : " + e.getMessage());
		}
	}

	public static void main (String[] args)  {

		final AccessContract accessContract = new AccessContract();
		accessContract.checkVersion();
		if(args.length < 2) {
			accessContract.logger.info("Usage : java AccessControl path password address");
			System.exit(0);
		}
		accessContract.getCredentials(args[0], args[1]);
		if(args.length < 3) {
			accessContract.logger.info("Usage : java AccessControl path password address a_text");
			System.exit(0);
		}
		accessContract.loadContract(args[2]);
		if(args.length < 4) {
			accessContract.logger.info("No string provided");
			System.exit(0);
		}
		accessContract.checkDocument(args[3]);
		accessContract.notarize(args[3]);
		accessContract.checkDocument(args[3]);
	}
}
